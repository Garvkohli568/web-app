pipeline {
  agent any
  options { timestamps() }

  stages {
    stage('Checkout') { steps { checkout scm } }
    stage('Build')    { steps { powershell 'npm ci' } }
    stage('Test')     { steps { powershell 'npm run test:ci' } }

    // TEMP deploy: start Node for a health check, then stop it again
    stage('Deploy (temp, no Docker)') {
      steps {
        powershell '''
          $env:PORT = 3000
          $p = Start-Process -FilePath "node" -ArgumentList "server.js" -PassThru
          Start-Sleep -Seconds 2
          Invoke-RestMethod http://localhost:3000/health | ConvertTo-Json
          Stop-Process -Id $p.Id -Force
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'Dockerfile,server.js,Views/**,Tests/**,package*.json', onlyIfSuccessful: false
    }
  }
}
